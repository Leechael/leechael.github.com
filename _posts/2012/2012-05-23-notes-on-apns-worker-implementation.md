---
layout: post
title: "谈谈 APNs 实现的 Scalability 问题"
---
很久没有写 blog 了，也就以这篇打开话匣子吧。这篇主要是对 APNs (Apple Push Notification Service) 的业务分析，如果你不知道 APNs 是什么，请可选跳过。 :D

第一个瓶颈会是需要处理的消息的数量。大量要处理的消息，如果在这里的业务模型是 Web Server 收到进行推送的命令，然后进行推送，最后返回处理结果，那么，在需要处理的消息超过 5000 以后（这个数字还得看 Web Server 允许的 timeout 是多久），问题出现了。

第二个瓶颈是数据库。基于 APNs 的业务特征，不多不少，你都需要数据库储存一堆 token。等待数据库返回查询结果需要多久呢？每一趟取出多少条消息进行处理比较恰当呢？当然做流处理更好，但这个是高级课题，不属于本文讨论范围。 :D

第三个瓶颈是处理进程的并发。这个属于和实现相当紧密的问题。MapReduce 或者 functional 的计算模型在处理这类型的问题很好使。

第四个瓶颈是单个处理进程的效率。对于 Advanced Format 的消息，使用异步模型较好；但这个选择，应该视乎程序的运行环境；使用一个对 async socket 不友好的开发语言，这个话题可以停止了。实际上，使用 Simple Format 的效率更好，这个情况下单个处理进程处理的效率基本上可以忽略掉，只剩下一个问题了：工程实现。

最后就是工程实现的问题了。TCP 链接重用，内存使用的多寡、CPU 的利用率、负载……扯远了？只看一个指标就好了：每分钟能处理掉的消息条目数。当然硬件设备、网络环境、水果那边的服务器响应速度（甚至水果那边的服务器挂掉了或者直接断掉你的链接致使需要处理消息数量剧增的雪崩问题）……这些一堆一堆的，应该归为工程实现问题。当然这些问题我仍没有遇到，所以我不说话——哪有人把自己的弱点暴露出来的……

其实，在处理上述问题之前，还需要注意一个指标：处理单条消息所需的时间。这个指标 **直接影响** 上面提及的第四个瓶颈：处理的效率。这里有一个问题：如果每一个处理进程的效率是不等的……这个问题应该在本年内我是无法遇见的了（实际上在我的实现中，也忽略掉这个问题），住嘴。

而上述的一切一切……最终都与你的业务模型和业务特点息息相关。前者可以分析得出，后者在分析以外、可能还需要一些监控数据才能进行评估，例如，**每分钟新增的消息条目数** ， **每分钟必须处理掉的消息条目数** 。注意，这两个数字是峰值，不是均数。

说了那么多，这只是对新浪微博上某评论的回复。

P.S.: 其实上面已经说到衡量工程实现如何做的两个关键指标了。
